<IfModule mod_headers.c>
    # Remove any existing Access-Control headers to prevent duplicates
    Header unset Access-Control-Allow-Origin
    Header unset Access-Control-Allow-Methods
    Header unset Access-Control-Allow-Headers
    Header unset Access-Control-Allow-Credentials
    Header unset Access-Control-Max-Age
    
    # Development origins (localhost)
    SetEnvIf Origin "^http://localhost:3000$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^http://localhost(:[0-9]+)?$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^http://127\.0\.0\.1:3000$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^http://127\.0\.0\.1(:[0-9]+)?$" ORIGIN_ALLOWED=$0
    
    # Production origins (HTTP)
    SetEnvIf Origin "^http://user\.gnews\.ma$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^http://api\.gnews\.ma$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^http://([a-z0-9-]+\.)?gnews\.ma$" ORIGIN_ALLOWED=$0
    
    # Production origins (HTTPS) - Always use HTTPS in production!
    SetEnvIf Origin "^https://user\.gnews\.ma$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^https://api\.gnews\.ma$" ORIGIN_ALLOWED=$0
    SetEnvIf Origin "^https://([a-z0-9-]+\.)?gnews\.ma$" ORIGIN_ALLOWED=$0
    
    # Only set headers if origin is allowed
    Header always set Access-Control-Allow-Origin "%{ORIGIN_ALLOWED}e" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS, DELETE, PUT, PATCH" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Credentials "true" env=ORIGIN_ALLOWED
    Header always set Access-Control-Max-Age "3600" env=ORIGIN_ALLOWED
</IfModule>

# Handle preflight OPTIONS requests
RewriteEngine On
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Optional: Force HTTPS in production (uncomment when ready)
# RewriteCond %{HTTPS} off
# RewriteCond %{HTTP_HOST} gnews\.ma$ [NC]
# RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]